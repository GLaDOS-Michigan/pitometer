#!/bin/bash
# Run a Network experiment

ROOT_DIR="/home/nudzhang/Documents/pitometer/measurements/experiments/data/network"
GIT_BRANCH="measurements"
NODES_IDS=("1" "2" "3" "4" "5" "6")

INTERVAL=100  # ping interval in ms
DURATION=3600   # duration for each trial in seconds
PAYLOADS=("0" "16" "32" "256" "512" "1024" "2048" "4096")  # payload size variable
TIMESTAMP=$(date +"%d-%b-%H%M")

echo "Starting new Network experiment at time $TIMESTAMP"
echo ""
./git_pull_all_hosts $GIT_BRANCH
echo ""

# Build locally and send executables to the target machines
./build_to_hosts ${NODES_IDS[@]}

for payload_size in "${PAYLOADS[@]}"
do
    time=$(date +"%d-%b-%H%M")
    echo "Starting trial with payload size $payload_size bytes at time $time"

    trial_dir="$ROOT_DIR/$TIMESTAMP/payload$payload_size"
    mkdir -p $trial_dir 

    # Start trial
    ./start_network_trial $trial_dir $INTERVAL $payload_size $DURATION > $trial_dir/info.log
done

end_timestamp=$(date +"%d-%b-%H%M")
echo "Toylock experiment completed at time $end_timestamp"
