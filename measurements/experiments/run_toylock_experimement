#!/bin/bash
# Run a Toylock experiment

ROOT_DIR="/home/nudzhang/Documents/pitometer/measurements/experiments/data/toylock"
GIT_BRANCH="measurements"

NUM_ROUNDS=4000
DELAYS=("0" "20" "50" "100" "200")
RING_SIZES=("1" "2" "3" "4" "5" "6")
TIMESTAMP=$(date +"%d-%b-%H%M")

echo "Starting new Toylock experiment at time $TIMESTAMP"
echo ""
./git_pull_all_hosts $GIT_BRANCH
echo ""

for ring_size in "${RING_SIZES[@]}"
do
    # Generate node id's to use
    node_ids=()
    for ((id=6;id>$[ 6 - $ring_size ];id--))
    do
        node_ids+=("$id")
    done

    # Build locally and send executables to the target machines
    ./build_to_hosts ${node_ids[@]}
    echo ""

    for delay in "${DELAYS[@]}"
    do
        time=$(date +"%d-%b-%H%M")
        echo "Starting trial with ring-size $ring_size and delay $delay at time $time"

        trial_dir="$ROOT_DIR/$TIMESTAMP/size$ring_size/delay$delay"
        mkdir -p $trial_dir 

        # Start trial
        ./start_toylock_trial $trial_dir $NUM_ROUNDS $delay ${node_ids[@]} > $trial_dir/info.log
    done
done

end_timestamp=$(date +"%d-%b-%H%M")
echo "Toylock experiment completed at time $end_timestamp"
