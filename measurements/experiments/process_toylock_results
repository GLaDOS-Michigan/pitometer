#!/bin/bash
# This script takes the following positional arguments
# ./process_toylock_results <root_dir>
# Converts each log file in <root_dir>, and its sub-directories into separate csv files 
# for each toylock stopwatch. It places each resulting csv in the directory of its 
# corresponding log file. Then, it calls analyze_toylock.py to generate graphs

ROOT_DIR=$1

LOGFILES=(`find $ROOT_DIR -type f -name node*_*.log`)

echo "Processing results in $ROOT_DIR"
# find $ROOT_DIR -type f -name "*.pdf" -delete

for lf in "${LOGFILES[@]}"
do :
    echo "        Converting file $lf"
    dir=$(dirname "${lf}")      # directory path
    name=$(basename -- "$lf")
    ext="${name##*.}"          
    name="${name%.*}"           # filename without extension

    # Convert to csv. Currently there are two Stopwatches:
    #   - NodeNextGrant
    #   - NodeNextAccept

    grantcsv=$dir/"$name"_grant.csv
    cat $lf | grep "NodeNextGrant" > $grantcsv

    acceptcsv=$dir/"$name"_accept.csv
    cat $lf | grep "NodeNextAccept" > $acceptcsv
done

python3 analyze_toylock.py $ROOT_DIR

find $ROOT_DIR -type f -name "*.csv" -delete
